<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Empower International Academy Transport</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="{{ url_for('static', filename='images/empower_logo.jpg') }}" alt="Empower International Academy" style="width: 45px; height: 45px; object-fit: contain; margin-right: 10px;">
                <span>Empower Academy Transport</span>
            </div>
            <div class="nav-menu">
                <span class="username">Welcome, {{ username }}</span>
                <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        {% if show_print_preview and is_new_residence %}
        <div class="success-notification new-residence">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM10 17L5 12L6.41 10.59L10 14.17L17.59 6.58L19 8L10 17Z" fill="currentColor"/>
            </svg>
            <div>
                <strong>ðŸŽ‰ New Residence Added: {{ print_residence }}!</strong>
                <p>Student registered successfully. Opening print preview for <strong>{{ print_residence }}</strong> residence only.</p>
            </div>
        </div>
        {% elif show_print_preview %}
        <div class="success-notification">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
            </svg>
            <div>
                <strong>Student added successfully!</strong>
                <p>Opening print preview for <strong>{{ print_residence }}</strong> residence.</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Add Student Form -->
        <section class="card">
            <h2>Add New Student</h2>
            <form method="POST" action="{{ url_for('add_student') }}" class="student-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Student Name *</label>
                        <input type="text" id="name" name="name" required placeholder="Enter full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="year">Year/Class *</label>
                        <select id="year" name="year" required>
                            <option value="">Select Year</option>
                            {% for year in years %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fee">Transportation Fee (UGX) *</label>
                        <input type="number" id="fee" name="fee" required min="0" step="1000" 
                               placeholder="Enter fee amount">
                    </div>
                    
                    <div class="form-group">
                        <label for="residence">Place of Residence *</label>
                        <input type="text" id="residence" name="residence" required 
                               placeholder="e.g., Kampala, Entebbe, Jinja">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="paid" name="paid">
                            <span>Payment Received</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-primary">Add Student</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Analytics Section -->
        <section class="analytics-grid">
            <div class="card">
                <h3>Students by Year</h3>
                <canvas id="yearChart"></canvas>
            </div>
            
            <div class="card">
                <h3>Fees by Residence</h3>
                <canvas id="residenceChart"></canvas>
            </div>
            
            <div class="card">
                <h3>Payment Status</h3>
                <canvas id="paymentChart"></canvas>
            </div>
            
            <div class="card">
                <h3>Fee Distribution</h3>
                <canvas id="feeDistributionChart"></canvas>
            </div>
        </section>

        <!-- Budget Summary -->
        <section class="card budget-summary">
            <h2>Budget Overview</h2>
            <div class="budget-grid">
                <div class="budget-item">
                    <div class="budget-label">Total Expected</div>
                    <div class="budget-value" id="totalExpected">UGX 0</div>
                </div>
                <div class="budget-item">
                    <div class="budget-label">Total Collected</div>
                    <div class="budget-value collected" id="totalCollected">UGX 0</div>
                </div>
                <div class="budget-item">
                    <div class="budget-label">Outstanding</div>
                    <div class="budget-value outstanding" id="totalOutstanding">UGX 0</div>
                </div>
                <div class="budget-item">
                    <div class="budget-label">Collection Rate</div>
                    <div class="budget-value" id="collectionRate">0%</div>
                </div>
            </div>
        </section>

        <!-- Students List -->
        <section class="card">
            <div class="card-header">
                <h2>Registered Students ({{ students|length }})</h2>
                <a href="{{ url_for('print_preview') }}" target="_blank" class="btn-secondary">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M16 8H14V4H6V8H4C2.9 8 2 8.9 2 10V14H6V18H14V14H18V10C18 8.9 17.1 8 16 8ZM8 6H12V8H8V6ZM12 16H8V12H12V16ZM14 11.5C13.17 11.5 12.5 10.83 12.5 10C12.5 9.17 13.17 8.5 14 8.5C14.83 8.5 15.5 9.17 15.5 10C15.5 10.83 14.83 11.5 14 11.5Z" fill="currentColor"/>
                    </svg>
                    Print Preview
                </a>
            </div>
            
            {% if students %}
            <div class="table-container">
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Year</th>
                            <th>Residence</th>
                            <th>Fee (UGX)</th>
                            <th>Paid</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.name }}</td>
                            <td>{{ student.year }}</td>
                            <td>{{ student.residence }}</td>
                            <td>{{ "{:,.0f}".format(student.fee) }}</td>
                            <td>
                                <label class="payment-toggle">
                                    <input type="checkbox" 
                                           {% if student.paid %}checked{% endif %}
                                           onchange="updatePayment({{ student.id }}, this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('delete_student', student_id=student.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this student?');">
                                    <button type="submit" class="btn-delete">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor" opacity="0.3"/>
                </svg>
                <p>No students registered yet. Add your first student above.</p>
            </div>
            {% endif %}
        </section>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    
    {% if show_print_preview %}
    <script>
        // Auto-open print preview in new window when new student is added
        window.addEventListener('load', function() {
            setTimeout(function() {
                {% if print_residence %}
                // Open residence-specific print preview
                window.open('{{ url_for("print_residence", residence=print_residence) }}', '_blank', 'width=1000,height=800');
                {% else %}
                // Open full print preview
                window.open('{{ url_for("print_preview") }}', '_blank', 'width=1000,height=800');
                {% endif %}
            }, 500);
        });
    </script>
    {% endif %}
</body>
</html>
